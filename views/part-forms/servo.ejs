<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Creepster&display=swap">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .channel-button {
            padding: 10px;
            text-align: center;
            background-color: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            cursor: pointer;
        }
        .channel-button.selected {
            background-color: #00ff00;
            color: #000000;
        }
        .servo-type-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1 class="landing-title"><%= title %></h1>
    </header>

    <main>
        <form action="<%= action %>?returnTo=/parts?characterId=<%= character ? character.id : (part ? part.characterId : '') %>" method="POST" id="servoForm">
            <input type="hidden" name="type" value="servo">
            <% if (part && part.id) { %>
                <input type="hidden" name="id" value="<%= part.id %>">
            <% } %>
            
            <div class="form-group">
                <label for="name">Part Name:</label>
                <input type="text" id="name" name="name" value="<%= part ? part.name : '' %>" required>
            </div>

            <div class="form-group">
                <label for="characterId">Character:</label>
                <select id="characterId" name="characterId" required>
                    <% characters.forEach(function(character) { %>
                        <option value="<%= character.id %>" <%= (part && part.characterId === character.id) ? 'selected' : '' %>>
                            <%= character.char_name %>
                        </option>
                    <% }); %>
                </select>
            </div>

            <div class="form-group">
                <label for="servoType">Servo Type:</label>
                <div class="servo-type-container">
                    <select id="servoType" name="servoType" required onchange="updateServoParameters()">
                        <option value="">Select a Servo Type</option>
                        <% servoConfigs.forEach(function(servo) { %>
                            <option value="<%= servo.name %>" 
                                    data-min-pulse="<%= servo.min_pulse_width_us %>"
                                    data-max-pulse="<%= servo.max_pulse_width_us %>"
                                    data-default-angle="<%= servo.default_angle_deg %>"
                                    data-model="<%= servo.model %>"
                                    data-manufacturer="<%= servo.manufacturer %>"
                                    data-modes="<%= servo.mode.join(',') %>"
                                    data-torque="<%= servo.max_torque_kg_cm %>"
                                    data-rotation="<%= servo.rotation_range_deg %>"
                                    data-feedback="<%= servo.feedback %>"
                                    data-notes="<%= servo.notes || '' %>"
                                    <%= (part && part.servoType === servo.name) ? 'selected' : '' %>>
                                <%= servo.name %>
                            </option>
                        <% }); %>
                    </select>
                    <button type="button" class="button" onclick="openCustomizeModal()">Customize</button>
                </div>
            </div>

            <div id="servoInfo" class="config-section" style="display: none;">
                <p id="servoModel"></p>
                <p id="servoModes"></p>
                <p id="servoTorque"></p>
                <p id="servoRotation"></p>
                <p id="servoFeedback"></p>
                <p id="servoNotes"></p>
            </div>

            <div class="form-group">
                <label class="checkbox-label" for="usePCA9685">
                    <input type="checkbox" id="usePCA9685" name="usePCA9685" <%= (part && part.usePCA9685) ? 'checked' : '' %> onchange="togglePCA9685()">
                    Use PCA9685
                </label>
            </div>

            <div id="pca9685Fields" class="config-section" style="display: none;">
                <div class="form-group">
                    <label for="channel">PCA9685 Channel:</label>
                    <input type="number" id="channel" name="channel" value="<%= part ? part.channel : 0 %>" min="0" max="15" required>
                </div>
                <div class="form-group">
                    <label>Channel Position:</label>
                    <div class="channel-grid">
                        <% for (let i = 0; i < 16; i++) { %>
                            <div class="channel-button" data-channel="<%= i %>">
                                <%= i %> (<%= ['Top', 'Top', 'Top', 'Top', 'Upper Mid', 'Upper Mid', 'Upper Mid', 'Upper Mid', 'Lower Mid', 'Lower Mid', 'Lower Mid', 'Lower Mid', 'Bottom', 'Bottom', 'Bottom', 'Bottom'][i] %>)
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div id="gpioField" class="form-group" style="display: none;">
                <label for="pin">GPIO Pin:</label>
                <input type="number" id="pin" name="pin" value="<%= part ? part.pin : '' %>" min="0" max="27" required>
            </div>

            <input type="hidden" id="minPulse" name="minPulse" value="<%= part ? part.minPulse : 500 %>">
            <input type="hidden" id="maxPulse" name="maxPulse" value="<%= part ? part.maxPulse : 2500 %>">
            <input type="hidden" id="defaultAngle" name="defaultAngle" value="<%= part ? part.defaultAngle : 90 %>">
            <input type="hidden" id="customSettings" name="customSettings" value="<%= part && part.customSettings ? JSON.stringify(part.customSettings) : '' %>">

            <div class="button-group">
                <button type="submit" class="button primary-btn">Save Part</button>
            </div>
        </form>

        <!-- Customize Modal -->
        <div id="customizeModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeCustomizeModal()">&times;</span>
                <h2>Customize Servo Settings</h2>
                <form id="customizeForm" onsubmit="saveCustomSettings(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customMinPulse">Min Pulse Width (μs):</label>
                            <input type="number" id="customMinPulse" name="customMinPulse" required>
                        </div>
                        <div class="form-group">
                            <label for="customMaxPulse">Max Pulse Width (μs):</label>
                            <input type="number" id="customMaxPulse" name="customMaxPulse" required>
                        </div>
                        <div class="form-group">
                            <label for="customDefaultAngle">Default Angle (degrees):</label>
                            <input type="number" id="customDefaultAngle" name="customDefaultAngle" min="0" max="180" required>
                        </div>
                        <div class="form-group">
                            <label for="customRotationRange">Rotation Range (degrees):</label>
                            <input type="number" id="customRotationRange" name="customRotationRange" min="0" max="360" required>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="button primary-btn">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="config-section">
            <h2>Test Servo</h2>
            <div class="form-group">
                <label for="testAngle">Angle (0-180):</label>
                <input type="range" id="testAngle" min="0" max="180" value="90">
                <span id="angleValue">90</span>
            </div>
            <p id="servoDescription"></p>
            <div class="button-group">
                <button onclick="testServo()" class="button">Test Servo</button>
                <button onclick="stopServo()" class="button">Stop Test</button>
            </div>
            <div id="testResult"></div>
        </div>

        <div class="button-group">
            <a href="/parts?characterId=<%= character ? character.id : (part ? part.characterId : '') %>" class="button secondary-btn">Back to Parts</a>
            <a href="/system-config/servos" class="button">Manage Servo Configurations</a>
        </div>
    </main>

    <script>
        // ... (keep all existing JavaScript code unchanged) ...
    </script>
</body>
</html>
